{% load wbappointment_tags %}

{% if request.path == '/profile' and request.user.profile.type == 1 %}

    <style>

        .modal-schedule-cell-checkbox {
            display: flex;
            justify-content: center;
        }

        .modal-schedule-cell {
            display: flex;
            align-items: center;
        }

        .modal-schedule-header {
            text-align: center;
        }
        


    </style>

    <div class="modal fade" id="expertCommonSchedule" tabindex="-1" aria-labelledby="exampleModalLabel"
         aria-hidden="true">

        <div class="modal-dialog">

            <div class="modal-content" style="padding: 20px">

                <form method="post" action="{% url 'add_calendar_schedule' %}" id="expert-schedule-form">

                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Расписание</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <input type="hidden" name="origin-path" value="{{ request.path }}">
                    <input type="hidden" name="origin-query" value="{{ request.GET.urlencode }}">

                    {% get_expert_schedule_form_set_tag request as formset %}

                    <div class="row">
                        <div class="col modal-schedule-header">Доступен</div>
                        <div class="col modal-schedule-header">День недели</div>
                        <div class="col modal-schedule-header">Начало</div>
                        <div class="col modal-schedule-header">Конец</div>

                    </div>

                    <div style="padding: 10px;">

                        {% csrf_token %}
                        {{ formset.management_form }}
                        {% for form in formset %}

                            <div style="padding-bottom: 20px">

                                <div class="row">

                                    <div class="col modal-schedule-cell-checkbox">
                                        {{ form.is_work_day }}
                                    </div>

                                    <div class="col modal-schedule-cell">
                                        <label for="{{ form.start_time.id_for_label }}" class=""></label>
                                        {{ form.id }}
                                        {{ form.day_of_week }}
                                        {{ form.day_of_week.value | get_day_name }}
                                    </div>

                                    <div class="col modal-schedule-cell">
                                        <label for="{{ form.start_time.id_for_label }}" class=""></label>
                                        {{ form.start_time }}
                                    </div>

                                    <div class="col modal-schedule-cell">
                                        <label for="{{ form.start_time.id_for_label }}" class=""></label>
                                        {{ form.end_time }}
                                    </div>

                                </div>

                            </div>

                        {% endfor %}

                    </div>

                    <div class="modal-footer">
                        <button type="submit" id="expert-schedule-form-submit-btn" class="btn btn-primary"
                                data-bs-dismiss="modal">Сохранить
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                    </div>

                </form>

            </div>

        </div>

    </div>

<script>
    function showExpertScheduleForm() {
        $('#expertCommonSchedule').modal("show");
    }

    function addExpertScheduleLink() {
        // Запрашиваем список часовых поясов с сервера
        $.get('/api/timezones/', function(data) {
            const timezones = data.timezones;
            let timezoneOptions = '';
            for (const tz of timezones) {
                timezoneOptions += `<option value="${tz}">${tz}</option>`;
            }

            const expertScheduleHTML = `
                <div id="expert-schedule-mobile" class="d-flex d-lg-none flex-column align-items-center gap-2 mb-3">
                    <select id="timezone-select" class="form-select form-select-sm w-100">
                        ${timezoneOptions}
                    </select>
                    <a class="btn btn-primary btn-sm w-100" onclick="showExpertScheduleForm()">Настроить расписание</a>
                </div>
                <div id="expert-schedule-desktop" class="d-none d-lg-flex align-items-center gap-2 mb-3">
                    <select id="timezone-select-desktop" class="form-select form-select-sm" style="width: auto" >
                        ${timezoneOptions}
                    </select>
                    <a class="btn btn-primary btn-sm" onclick="showExpertScheduleForm()">Настроить расписание</a>
                </div>
            `;

            $('#consultations').prepend(expertScheduleHTML);

            // Установить текущий часовой пояс пользователя
            $('#timezone-select').val('{{ request.user.profile.timezone }}');
            $('#timezone-select-desktop').val('{{ request.user.profile.timezone }}');

            // Обработчик изменения часового пояса
            $('#timezone-select, #timezone-select-desktop').change(function() {
                const newTimezone = $(this).val();
                $.ajax({
                    url: '{% url "update_user_timezone" %}',  // Предполагаемый URL для обновления часового пояса
                    type: 'POST',
                    data: {
                        timezone: newTimezone,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    success: function(response) {
                        console.log('Часовой пояс обновлен:', response);
                        // Можно добавить уведомление пользователю об успешном обновлении
                    },
                    error: function(xhr, status, error) {
                        console.error('Ошибка при обновлении часового пояса:', error);
                        // Можно добавить уведомление пользователю об ошибке
                    }
                });
            });
        });
    }

    $('#expert-schedule-form').submit(function (event) {
        event.preventDefault();
        const form = $(this);
        $.ajax({
            url: '{% url "add_calendar_schedule" %}',
            type: 'POST',
            data: form.serialize(),
            success: function (response) {
                console.log(response.result);
                console.log(response.data);
            }
        });
    });

    $(function () {
        addExpertScheduleLink();
    });
</script>


{% endif %}
