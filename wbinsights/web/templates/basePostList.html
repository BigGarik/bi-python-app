{% extends 'base123.html' %}
{% load web_tags %}
{% load static %}

{% block center_col %}
    <link rel="stylesheet" href="{% static 'web/css/basepost_list_css.css' %}">


    <div class="element-container">
        <div class="article-text-top">
            <span class="article-news">Новости</span>
            <span class="news-open-close" role="button" data-expanded="true">
                <i class="bi bi-chevron-up"></i>
                &nbsp; свернуть
            </span>
        </div>

        <div class="collapse-content" id="collapseNews">
            <div class="col-md-12">

                <div id="newsCarousel" class="carousel-container">
                    {% get_all_news as news_items %}

                    {% if news_items %}
                        <div class="carousel-track">

                            {% for news in news_items %}
                                <div class="carousel-card {% if forloop.counter == 2 %}active{% endif %}">

                                    <div class="news-title">
                                        <a href="{{ news.link }}" class="news-titles"
                                           target="_blank">{{ news.title }}</a>
                                    </div>
                                </div>

                            {% endfor %}
                        </div>

                        <button class="carousel-nav prev">
                            <i class="bi bi-chevron-left"></i>
                        </button>

                        <button class="carousel-nav next">
                            <i class="bi bi-chevron-right"></i>
                        </button>

                    {% else %}
                        <div class="text-center p-3">
                            <p>Нет последних новостей</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% split request.path "/" 'first' as url_first_part %}

    <div class="d-block d-md-none">
        <div class="dropdown post-menu">
            <button class="dropbtn">
                {% if url_first_part == 'researches' %}
                    Исследования
                {% elif url_first_part == 'articles' %}
                    Статьи
                {% elif url_first_part == 'wbqa' or url_first_part == 'question_answer' %}
                    Вопрос-ответ
                {% else %}
                    Эксперты
                {% endif %}
                <span class="arrow-down"></span>
            </button>

            <div class="dropdown-content">
                {% if url_first_part != 'researches' %}
                    <a href="{% url 'research_list' %}" class="post-menu-item-mobile">Исследования</a>
                {% endif %}
                {% if url_first_part != 'experts' and url_first_part != '' %}
                    <a href="{% url 'experts_list' %}" class="post-menu-item-mobile">Эксперты</a>
                {% endif %}
                {% if url_first_part != 'articles' %}
                    <a href="{% url 'article_list' %}" class="post-menu-item-mobile">Статьи</a>
                {% endif %}
                {% if url_first_part != 'wbqa' and url_first_part != 'question_answer' %}
                    <a href="{% url 'question_list' %}" class="post-menu-item-mobile">Вопрос-ответ</a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="d-none d-md-flex post-menu">
        <a href="{% url 'research_list' %}"
           class="post-menu-item {% if url_first_part == 'researches' or url_first_part == '' %} selected {% endif %}">Исследования</a>
        <a href="{% url 'experts_list' %}"
           class="post-menu-item {% if url_first_part == 'experts' %} selected {% endif %}">Эксперты</a>
        <a href="{% url 'article_list' %}"
           class="post-menu-item {% if url_first_part == 'articles' %} selected {% endif %}">Статьи</a>
        <a href="{% url 'question_list' %}"
           class="post-menu-item {% if url_first_part == 'wbqa' or url_first_part == 'question_answer' %} selected {% endif %}">Вопрос-ответ</a>
    </div>

    <div id="article_list" class="content-block">
        {% block posts_content %}{% endblock %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const config = {
                track: document.querySelector('.carousel-track'),
                cards: document.querySelectorAll('.carousel-card'),
                currentIndex: 1,
                autoRotateInterval: 5000,
                autoRotate: null,
                isMobile: window.innerWidth <= 768,
                touchStartX: 0,
                touchEndX: 0,
                minSwipeDistance: 50,
                isAnimating: false
            };

            const carousel = {
                update() {

                    // const offset = (config.currentIndex * -100) / config.cards.length;

                    const transformValue = config.isMobile
                        ? -config.currentIndex * 100
                        : -config.currentIndex * (100 / 3) + (100 / 3);

                    config.track.style.transform = `translateX(${transformValue}%)`;

                    config.cards.forEach((card, index) =>
                        card.classList.toggle('active', index === config.currentIndex)
                    );

                    {#if (config.currentIndex >= config.cards.length - 1) {#}
                    {#    setTimeout(() => {#}
                    {#        config.track.style.transition = 'none';#}
                    {#        config.currentIndex = 1;#}
                    {#        this.update();#}
                    {#        setTimeout(() => config.track.style.transition = 'transform 0.5s ease-in-out', 50);#}
                    {#    }, 500);#}

                },

                resetAutoRotation() {

                    if (config.autoRotate) {
                        clearInterval(config.autoRotate);
                    }

                    config.autoRotate = setInterval(() => this.move(1), config.autoRotateInterval);
                    // console.log('auto rotate 5 sec');
                },

                move(direction) {


                    // if (config.isAnimating) return;

                    // setTimeout(() => config.isAnimating = false, 500);

                    if (config.isAnimating) return;
                    config.isAnimating = true;

                    config.currentIndex = (config.currentIndex + direction + config.cards.length) % config.cards.length;
                    this.update();
                    this.resetAutoRotation();


                    // console.log('config.cards.length', config.cards.length);
                    // console.log('starting index', config.currentIndex);


                    setTimeout(() => {
                        config.isAnimating = false;
                    }, 500);
                },

                handleTouchStart(e) {
                    config.touchStartX = e.touches[0].clientX;
                },

                handleTouchMove(e) {

                    if (!config.touchStartX) return;

                    e.preventDefault();
                    config.touchEndX = e.touches[0].clientX;

                    const swipeDistance = config.touchStartX - config.touchEndX;

                    const currentTransform = config.isMobile
                        ? -config.currentIndex * 100
                        : -config.currentIndex * (100 / 3) + (100 / 3);

                    const dragTransform = (swipeDistance / config.track.offsetWidth) * 100;

                    config.track.style.transform = `translateX(${currentTransform - dragTransform}%)`;
                },

                handleTouchEnd() {

                    if (!config.touchStartX || !config.touchEndX) return;

                    const swipeDistance = config.touchStartX - config.touchEndX;

                    if (Math.abs(swipeDistance) > config.minSwipeDistance) {
                        this.move(swipeDistance > 0 ? 1 : -1);
                    } else {
                        this.update();
                    }

                    config.touchStartX = 0;
                    config.touchEndX = 0;
                },

                handleResize() {

                    const wasMobile = config.isMobile;
                    config.isMobile = window.innerWidth <= 768;

                    if (wasMobile !== config.isMobile) {
                        this.update();
                    }
                },

                init() {

                    this.resetAutoRotation();

                    const container = document.querySelector('.carousel-container');

                    container.addEventListener('touchstart', (e) => this.handleTouchStart(e), {passive: false});
                    container.addEventListener('touchmove', (e) => this.handleTouchMove(e), {passive: false});
                    container.addEventListener('touchend', () => this.handleTouchEnd());

                    document.querySelector('.carousel-nav.prev').onclick = () => this.move(-1);
                    document.querySelector('.carousel-nav.next').onclick = () => this.move(1);

                    container.onmouseenter = () => clearInterval(config.autoRotate);
                    container.onmouseleave = () => this.resetAutoRotation();

                    window.addEventListener('resize', () => this.handleResize());

                    this.update();
                }
            };

            const collapse = {

                init() {

                    const toggle = document.querySelector('.news-open-close');
                    const content = document.getElementById('collapseNews');

                    toggle.onclick = () => {

                        const isExpanded = toggle.getAttribute('data-expanded') === 'true';

                        content.classList.toggle('hidden');

                        toggle.innerHTML = isExpanded ?
                            '<i class="bi bi-chevron-down"></i>&nbsp; развернуть' :
                            '<i class="bi bi-chevron-up"></i>&nbsp; свернуть';
                        toggle.setAttribute('data-expanded', !isExpanded);
                    };
                }
            };

            const dropdown = {

                toggleDropdown(event) {

                    event.stopPropagation();
                    const dropdown = event.currentTarget.nextElementSibling;
                    dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
                },


                {#toggleDropdown(event) {#}
                {##}
                {#    event.stopPropagation();#}
                {##}
                {#    const dropdown = event.currentTarget.nextElementSibling;#}
                {##}
                {#    if (dropdown.style.maxHeight) {#}
                {#        dropdown.style.maxHeight = null;#}
                {#        setTimeout(() => dropdown.style.display = "none", 300);#}
                {#    } else {#}
                {#        dropdown.style.display = "block";#}
                {#        dropdown.style.maxHeight = dropdown.scrollHeight + "px";#}
                {#    }#}



                init() {

                    document.querySelectorAll('.dropbtn').forEach(btn =>
                        btn.onclick = this.toggleDropdown
                    );

                    document.onclick = (event) => {

                        if (!event.target.matches('.dropbtn')) {

                            document.querySelectorAll('.dropdown-content').forEach(
                                dropdown => dropdown.style.display = "none"
                            );
                        }
                    };
                }
            };

            carousel.init();
            collapse.init();
            dropdown.init();
        });
    </script>
{% endblock %}