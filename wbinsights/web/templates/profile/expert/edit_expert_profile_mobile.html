{% extends 'base123.html' %}
{% load static %}
{% load i18n %}
{% load web_tags %}
{% block extra_static %}
    <link rel="stylesheet" href="{% static 'web/css/profile_edit.css' %}">
    <link rel="stylesheet" href="{% static 'web/css/edit_expert_profile_mobile_css.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet"/>
{% endblock %}

{% block center_col %}

    <style>
        .bi-trash:hover {
            color: red;
            cursor: pointer;
        }
    </style>


    <div class="element-container basepost-content-mobile-bottom-padding">
        <div class="edit-prof-info-cont">

            <div class="position-relative" aria-live="polite" aria-atomic="true">
                <div class="toast-container position-fixed bottom-0 end-0 p-3">
                    {% if user_form.errors or profile_form.errors or expert_profile_form.errors %}
                        {% for field, errors in user_form.errors.items %}
                            {% for error in errors %}
                                <div class="toast align-items-center text-bg-danger border-0" role="alert"
                                     aria-live="assertive" aria-atomic="true">
                                    <div class="d-flex">
                                        <div class="toast-body" style="width: 90%">
                                            {{ field }}: {{ error }}
                                        </div>
                                        <button type="button" class="btn-close btn-close-white me-2 m-auto"
                                                data-bs-dismiss="toast" aria-label="Close" style="width: 10%"></button>

                                    </div>
                                </div>
                            {% endfor %}
                        {% endfor %}

                        {% for field, errors in profile_form.errors.items %}
                            {% for error in errors %}
                                <div class="toast align-items-center text-bg-danger border-0" role="alert"
                                     aria-live="assertive" aria-atomic="true">
                                    <div class="d-flex">
                                        <div class="toast-body" style="width: 90%">
                                            {{ field }}: {{ error }}
                                        </div>
                                        <button type="button" class="btn-close btn-close-white me-2 m-auto"
                                                data-bs-dismiss="toast" aria-label="Close" style="width: 10%"></button>

                                    </div>
                                </div>
                            {% endfor %}
                        {% endfor %}

                        {% for field, errors in expert_profile_form.errors.items %}
                            {% for error in errors %}
                                <div class="toast align-items-center text-bg-danger border-0" role="alert"
                                     aria-live="assertive" aria-atomic="true">
                                    <div class="d-flex">
                                        <div class="toast-body" style="width: 90%">
                                            {{ field }}: {{ error }}
                                        </div>
                                        <button type="button" class="btn-close btn-close-white me-2 m-auto"
                                                data-bs-dismiss="toast" aria-label="Close" style="width: 10%"></button>

                                    </div>
                                </div>
                            {% endfor %}
                        {% endfor %}
                    {% endif %}
                </div>
            </div>

            {% trans "BackButtonLabel" as back_text %}
            {% back_button "profile" back_text %}

            <div>
                <span class="prof-edit-page-title">Настройки профиля ({{ request.user.email }})</span>
            </div>
{#                 not needed because we us bootstrap vlidatiopn#}
{#            {{ user_form.errors }}#}
{#            {{ profile_form.errors }}#}
{#            {{ expert_profile_form.errors }}#}

            <form method="post" enctype="multipart/form-data" novalidate class="needs-validation">
                {% csrf_token %}
                <div class="prof-edit-rows">
                    <div class="d-md-flex d-block my-2">
                        <div class="prof-edit-info-cont">
                            <label for="{{ user_form.first_name.id_for_label }}"
                                   class="prof-edit-input-labels">{{ user_form.first_name.label }}</label>
                            {{ user_form.first_name }}
                        </div>
                        <div class="prof-edit-info-cont">
                            <label for="{{ user_form.last_name.id_for_label }}"
                                   class="prof-edit-input-labels">{{ user_form.last_name.label }}</label>
                            {{ user_form.last_name }}
                        </div>
                    </div>

                    <div class="full-width">
                        <label for="{{ expert_profile_form.about.id_for_label }}"
                               class="prof-edit-input-labels">{{ expert_profile_form.about.label }}</label>
                        {{ expert_profile_form.about }}

                        {% if grade %}
                            <p>Грейд: {{ grade.grade }}</p>
                            <p>Диапазон стоимости часа для вашего Грейда: от {{ grade.min_cost }}
                                до {{ grade.max_cost }}</p>
                        {% else %}
                            <p>Нет данных для ваших points.</p>
                        {% endif %}
                    </div>
                </div>

                <div class="expert-edit-rows">
                    <div class="prof-edit-photo-cont">
                        <img src="{{ user.profile.avatar.url }}" alt="Avatar" class="avatar-img">
                        <div class="avatar-info">
                            {% if profile_form.instance.avatar %}
                                <p class="avatar-current-file">На данный момент: <a
                                        href="{{ profile_form.instance.avatar.url }}"
                                        class="avatar-current-link">{{ profile_form.instance.avatar.name }}</a></p>
                            {% endif %}
                            <label for="id_avatar">Изменить:</label>
                            <input type="file" name="avatar" class="smaller-letters" accept="image/*" id="id_avatar">
                        </div>
                    </div>
                    <div class="d-md-flex d-block my-2">
                        <div class="prof-edit-input-title">
                            <label for="{{ expert_profile_form.expert_categories.id_for_label }}"
                                   class="prof-edit-input-labels">{{ expert_profile_form.expert_categories.label }}</label>
                            <div class="profile-category-choose">
                                {{ expert_profile_form.expert_categories }}
                            </div>
                        </div>
                        <div class="prof-edit-input-title">
                            <label for="{{ expert_profile_form.experience.id_for_label }}"
                                   class="prof-edit-input-labels">{{ expert_profile_form.experience.label }}</label>
                            <div class="profile-category-choose">
                                {{ expert_profile_form.experience }}
                            </div>
                        </div>
                        <div class="prof-edit-input-title">
                            <label for="{{ expert_profile_form.hour_cost.id_for_label }}"
                                   class="prof-edit-input-labels">{{ expert_profile_form.hour_cost.label }}</label>
                            {% if grade %}
                                <input type="number" name="hour_cost"
                                       id="{{ expert_profile_form.hour_cost.id_for_label }}"
                                       min="{{ grade.min_cost }}" max="{{ grade.max_cost }}" step="1"
                                       value="{{ expert_profile_form.hour_cost.value }}" class="custom-form-css">
                            {% else %}
                                {{ expert_profile_form.hour_cost }}
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="expert-edit-rows">
                    <div class="d-md-flex d-block my-2">
                        <div class="prof-edit-info-cont">
                            <label for="{{ expert_profile_form.age.id_for_label }}"
                                   class="prof-edit-input-labels">{{ expert_profile_form.age.label }}</label>
                            {{ expert_profile_form.age }}
                        </div>
                    </div>
                </div>
                <div class="expert-edit-rows">
                    <div class="d-md-flex d-block my-2">
                        <div class="prof-edit-info-cont">
                            <label for="{{ expert_profile_form.hh_link.id_for_label }}"
                                   class="prof-edit-input-labels">{{ expert_profile_form.hh_link.label }}</label>
                            {{ expert_profile_form.hh_link }}
                        </div>
                    </div>
                </div>
                <div class="expert-edit-rows">
                    <div class="d-md-flex d-block my-2">
                        <div class="prof-edit-info-cont">
                            <label for="{{ expert_profile_form.linkedin_link.id_for_label }}"
                                   class="prof-edit-input-labels">{{ expert_profile_form.linkedin_link.label }}</label>
                            {{ expert_profile_form.linkedin_link }}
                        </div>
                    </div>
                </div>
                <hr/>
                <!-- Добавляем формсет для образования -->
                <div class="education-formset-container">
                    <span class="prof-edit-page-title">Образование
                        <div type="button" class="bi bi-plus add-education-btn-trigger"
                             style="background-color: #4CAF50; color: white; padding:0px 5px 0px 5px; border-radius: 4px; cursor: pointer;">
                        </div>
                    </span>
                    {{ education_expert_formset.management_form }}
                    {% for form in education_expert_formset %}
                        <div class="education-form col-12">
                            {{ form.id }}
                            {{ form.errors }}
                            <div class="row">
                                <div class="prof-edit-input-title1 col-6">
                                    <label for="{{ form.education_type.id_for_label }} "
                                           class="prof-edit-input-labels flex-space-between">{{ form.education_type.label }}
                                        {% if form.instance.id %}
                                            <div class="col-1 fle"
                                                 style="display: flex;justify-content: flex-end;height: fit-content;">
                                                <div class="bi bi-trash delete-education-btn" type="button"
                                                     style="font-size: 24px"
                                                     data-education-id="{{ form.instance.id }}"
                                                     data-education-name="{{ form.instance.educational_institution }}">
                                                </div>
                                            </div>
                                        {% endif %}
                                    </label>

                                    {{ form.education_type }}
                                </div>
                                <div class="prof-edit-input-title1 col-12" style="display: flex; align-items: center">
                                    <label for="{{ form.specialized_education.id_for_label }}"
                                           class="prof-edit-input-labels col-11"
                                           style="width: fit-content !important;">{{ form.specialized_education.label }}</label>
                                    {{ form.specialized_education }}
                                </div>

                            </div>
                            <div class="row">
                                <div class="prof-edit-input-title1 col-9">
                                    <label for="{{ form.educational_institution.id_for_label }}"
                                           class="prof-edit-input-labels">{{ form.educational_institution.label }}</label>
                                    {{ form.educational_institution }}
                                </div>
                                <div class="prof-edit-input-title1 col-3">
                                    <label for="{{ form.diploma_number.id_for_label }}"
                                           class="prof-edit-input-labels">{{ form.diploma_number.label }}</label>
                                    {{ form.diploma_number }}
                                </div>
                            </div>

                        </div>
                    {% endfor %}


                    <!-- Add this container for new forms -->
                    <div id="new-education-forms-container"></div>
                </div>
                <hr/>
                <div class="prof-edit-bot-btns-cont">

                    {% include "components/loadingBtn.html" with button_text="Сохранить изменения" loading_text="Сохранение..." %}

                    <button type="button" class="btn btn-secondary prof-edit-delete-btn" id="deleteProfileBtn"
                            data-bs-toggle="modal" data-bs-target="#deleteProfileModal">
                        Удалить профиль
                    </button>
                </div>
            </form>

            <div class="modal fade" id="deleteEducationModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Подтверждение удаления</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Вы уверены, что хотите удалить образование "<span id="educationNameToDelete"></span>"?
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                            <button type="button" class="btn btn-danger" id="confirmDeleteEducation">Удалить</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" tabindex="-1" role="dialog" id="deleteProfileModal">
                <div class="modal-dialog" role="document">
                    <form method="post">
                        <div class="modal-content modal-custom">
                            <div class="modal-header modal-header-custom">
                                <h4 class="modal-title">Вы действительно хотите удалить профиль?</h4>
                            </div>
                            <div class="modal-body">
                                <p>После удаления вы не сможете восстановить данные</p>
                            </div>
                            <div class="modal-footer modal-footer-custom">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                                <button type="submit" class="btn btn-danger">Удалить</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>



    {% if user_form.errors or profile_form.errors or expert_profile_form.errors %}
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const toastElList = document.querySelectorAll('.toast');
                toastElList.forEach(toastEl => {
                    const toast = new bootstrap.Toast(toastEl, {
                        autohide: false
                    });
                    toast.show();
                });
            });
        </script>
    {% endif %}

    <!-- Add form validation script -->
    <script>
        const form = document.querySelector("form")
        form.addEventListener('submit', e => {
            if (!form.checkValidity()) {
                e.preventDefault()
                e.stopPropagation()
            }
            form.classList.add('was-validated')
        })
    </script>

    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
    <script>
        const quill = new Quill('#{{ expert_profile_form.about.id_for_label }}', {
            theme: 'snow'
        });

        $(document).ready(function () {
            const emptyForm = $('#empty-form-template').html();

            $('.add-education-btn-trigger').click(function () {

                const newForm = $('.education-form:last').clone();

                newForm.find('input').val('');
                newForm.find('select').val('');

                const formNum = parseInt($('#id_form-TOTAL_FORMS').val());
                newForm.attr('data-new-form', formNum);

                const formRegex = RegExp('form-(\\d+)-', 'g');
                newForm.html(newForm.html().replace(formRegex, 'form-' + formNum + '-'));

                newForm.find('.bi-trash').remove();
                newForm.find('.col-1').html(`
                <div class="bi bi-trash delete-temp-education-btn" type="button"
                     style="font-size: 24px"
                     data-new-form="${formNum}">
                </div>
            `);


                $('#id_form-TOTAL_FORMS').val(formNum + 1);

                $('#new-education-forms-container').append('<hr/>');
                $('#new-education-forms-container').append(newForm);
            });

            $(document).on('click', '.delete-temp-education-btn', function () {
                $(this).closest('.education-form').prev('hr').remove();
                $(this).closest('.education-form').remove();

                const totalForms = parseInt($('#id_form-TOTAL_FORMS').val());
                $('#id_form-TOTAL_FORMS').val(totalForms - 1);
            });


            $('.delete-education-btn').click(function () {
                const educationId = $(this).data('education-id');
                const educationName = $(this).data('education-name');
                $('#deleteEducationModal').data('education-id', educationId);
                $('#educationNameToDelete').text(educationName);
                $('#deleteEducationModal').modal('show');
            });

            $('#confirmDeleteEducation').click(function () {
                const educationId = $('#deleteEducationModal').data('education-id');

                $.ajax({
                    url: '/education/' + educationId + '/delete/',
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    success: function (response) {
                        if (response.success) {
                            $('#deleteEducationModal').modal('hide');
                            window.location.reload();
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function (xhr) {
                        alert('Error: ' + (xhr.responseJSON ? xhr.responseJSON.message : 'Unknown error occurred'));
                    }
                });
            });
        });


    </script>

{% endblock %}