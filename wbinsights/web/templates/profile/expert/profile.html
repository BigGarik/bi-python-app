{% extends 'base123.html' %}
{% load web_tags %}
{% load static %}
{% load i18n %}

{% block center_col %}
    <link rel="stylesheet" href="{% static 'web/css/profile.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-b1buSpv0JPw+Ic44JqBxZB8l+1cXpRK52fSlCHnEyZ/jJ8R2oG8rUwZ8t5yIrJvZ" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"
            integrity="sha384-cVJb8dQ6z+XoNX6FqZMhDIxQ1b/k7tJsOqW2bQNsN2gNV7P6LEHS2RRsKdf4EoAg"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-eAqHgH66lTjivfTl6o5x2R7FSP5Qb5H1sVaVYQ4H9Fti5Aq3ck+CpK5+JeIMI99e5"
            crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@event-calendar/build@2.6.1/event-calendar.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@event-calendar/build@2.6.1/event-calendar.min.js"></script>

    <script src="{% static 'js/moment-with-locales.min.js' %}"></script>


    <style>

        .ec-day-grid .ec-event-body, .ec-all-day .ec-event-body {
            flex-direction: column !important;
        }


<!--        .ec-event-body {-->
<!--            display: flex;-->
<!--            flex-direction: column !important;-->
<!--            width: 100%;-->
<!--        }-->

        .ec-resourceTimeGridWeek {
            display:none !important;
        }

        .ec-event-time {

            font-size: 12px !important;
        }

        .ec-event-title span {
            font-size: 12px !important;
            display: flex !important;
        }

        @media (max-width: 768px ) {

            .prof-page-pic-cont img {
                min-height: 100px !important;
                min-width: 100px !important;
            }

        }

        @media (min-width: 769px ) {
            .prof-page-pic-cont img {
                min-height: 130px !important;
                min-width: 130px !important;
            }
        }



        .modal {
            --bs-modal-width: 800px !important;
        }

        .ec-list .ec-event-title {
            display:flex;
            gap : 10px;

        }


    </style>

    <div class="prof-page-cont">

        <a href="{% url 'index' %}" class="to-main-page">
            <i class="bi bi-chevron-left chevro-left-css"></i>
            &nbsp;{% trans 'ToMainPageLabel' %}
        </a>

        <div class="profile-info-cont">

            <div class="col-12 top-half">

                <div class=" col-sm-3 prof-page-pic-cont">
                    <img src="{{ request.user.profile.avatar.url }}" alt="Avatar"
                         style="border-radius: 50%;width: 80px;height: 80px;object-fit: cover;">
                </div>

                <div class=" col-sm-9  profile-information-cont">

                    <div class="user-display-name">
                        {{ request.user.first_name }} {{ request.user.last_name }}
                    </div>

                    <div class="user-rating-cont">

                        <div class="user-rating">{% trans 'RatingLabel' %} {{ rating }} &nbsp;</div>

                        <div class="user-rate-and-stars">
                            {% for ch in filled_stars_chipher %}
                                {% if ch == 'f' %}
                                    <i class="bi bi-star-fill" style=" color: #e9be50; padding: 0 2px 0 2px"></i>
                                {% elif ch == 'h' %}
                                    <i class="bi bi-star-half" style=" color: #e9be50; padding: 0 2px 0 2px"></i>
                                {% elif ch == 'e' %}
                                    <i class="bi bi-star" style=" color: #e9be50; padding: 0 2px 0 2px"></i>
                                {% endif %}
                            {% endfor %}
                        </div>

                    </div>

                    <div class="user-category-cont">

                        <div class="user-category">Эксперт в области :</div>

                        <div class="displayflex">
                            {% for exp_category in request.user.expertprofile.expert_categories.all %}
                                <div class="user-catagory-highlight {{ exp_category.slug }}">
                                    {{ exp_category.name }}
                                </div>
                            {% endfor %}
                        </div>

                    </div>

                    <div class="user-stats">

                        {{ experts_articles_count }} {% get_write_phrase experts_articles_count 'статья статьи статей' %}
                        •
                        {{ experts_researches_count }} {% get_write_phrase experts_researches_count 'исследование исследования исследований' %}
                        • 24 отзыва

                    </div>

                    <div class="user-settings">

                        <a href="{% url 'profile_edit' %}" type="button"
                           class="btn prof-settings-btn">
                            {% trans 'EditProfileLabel' %}
                        </a>

                        <form method="post" action="{% url 'logout' %}">
                            {% csrf_token %}
                            <button class="btn prof-logout-btn" type="submit">
                                {% trans 'LogoutButtonLabel' %}
                            </button>
                        </form>

                    </div>

                </div>

            </div>



            <div class="bottom-half">

                <div class="bottom-info">

                    <div class="prof-bottom-cont">
                        <span class="bottom-bold-text">{% trans 'EducationLabel' %}: &nbsp;</span>
                        <span class="">{{ request.user.expertprofile.education }}</span>
                    </div>

                    <div class="prof-bottom-cont">

                        <span class="bottom-bold-text">{% trans 'ExperienceLabel' %}:&nbsp;</span>
                        <span class="">{{ request.user.expertprofile.experience }}
                            {% get_write_phrase request.user.expertprofile.experience 'год года лет' %}
                        </span>

                    </div>

                    <div class="prof-about-me-cont">
                        {{ request.user.expertprofile.about }}
                    </div>

                    <div class="prof-bottom-cont">

                        <span class="bottom-bold-text">{% trans 'PricePerHourLabel' %}:&nbsp;</span>
                        <span class=""> {{ request.user.expertprofile.hour_cost }} ₽/час</span>
                    </div>

                </div>

                <div class="prof-content-links-cont">
                    <div class="profile-menu-item" data-content="articles"
                         onclick="showContent('articles')">{% trans 'ArticlesTabLabel' %}
                        &nbsp;<span class="expert-profile-title-content-number">{{ experts_articles_count }}</span></div>
                    <div class="profile-menu-item" data-content="researches"
                         onclick="showContent('researches')">{% trans 'ResearchesTabLabel' %}
                        &nbsp;<span class="expert-profile-title-content-number">{{ experts_researches_count }}</span></div>
                    <div class="profile-menu-item" data-content="questions"
                         onclick="showContent('questions')">{% trans 'QuestionsTabLabel' %}
                        &nbsp;<span class="expert-profile-title-content-number">{{ experts_questions_count }}</span></div>
                    <div class="profile-menu-item" data-content="consultations"
                         onclick="showContent('consultations')">{% trans 'ConsultationsTabLabel' %}
                         &nbsp;<span class="expert-profile-title-content-number">   ({{ experts_appointment_cnt }})</span>
                    </div>
                    <div class="profile-menu-item" data-content="reviews"
                         onclick="showContent('reviews')">{% trans 'ReviewsTabLabel' %}</div>
                    {#                  <div class="profile-menu-item" data-content="notifications" onclick="showContent('notifications')">Уведомления</div>#}
                </div>

                <div id="articles" class="expert-content" style="display: none;">
                    {% for article in experts_articles %}

                        <div class="expert-content-cont">

                            <span class="article-title-loop-exp"><a href="{% url 'article_detail' article.slug %}"
                                                                    style="text-decoration: none;color: #36364b;">{{ article.title }}</a></span>
                            <span class="article-content-loop-exp">{{ article.description }}</span>
                            <span class="link-read-post">
                                <a href="{{ article.get_absolute_url }}" style="color:black;"
                                   class="link-read-post">{% trans 'ReadPostLabel' %} &nbsp;
                                    <i class="bi bi-chevron-down" style="color:black; scale:1.3"></i>
                                </a>
                            </span>

                            <div class="article-comments-andshare-cont-exp">
                                <div class="article-comments-exp">
                                    <i class="bi bi-chat-left-text" style="color:grey;"></i>&nbsp; 104
                                </div>
                                <div class="article-share-exp">
                                    <i class="bi bi-calendar2-week"
                                       style="color:grey; "></i>&nbsp; {{ article.time_update|custom_time_display }}

                                </div>
                            </div>

                        </div>

                        <hr>

                    {% endfor %}
                </div>


                <div id="researches" class="expert-content" style="display: none;">
                    <span>test research</span>
                    {% for research in experts_researches %}
                    {% endfor %}
                </div>

                <div id="questions" class="expert-content" style="display: none;">
                    <span>test questions</span>
                    {% for research in experts_researches %}
                    {% endfor %}
                </div>

                <div id="consultations" class="expert-content" style="display: none;">

                    <div id="event-calendar"></div>


                </div>

                <div id="reviews" class="expert-content" style="display: none;">
                    <span>test reviews</span>
                    {% for research in experts_researches %}
                    {% endfor %}
                </div>
                <div id="notifications" class="expert-content" style="display: none;">
                    <span>test notifications</span>
                    {% for research in experts_researches %}
                    {% endfor %}
                </div>

            </div>
        </div>
    </div>

    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Детали назначения</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">

                    <div id="appointmentTableBody"></div>
                    <table class="table" style="display:none">
                        <thead>
                            <tr>
                                <th scope="col"> Date </th>
                                <th scope="col"> Time </th>
                                <th scope="col"> Client Name </th>
                                <th scope="col"> Zoom </th>
                                <th scope="col"> Status </th>
                            </tr>
                        </thead>
                        <tbody >

                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
<!--                    <button type="button" class="btn btn-primary">Save changes</button>-->
                </div>
            </div>
        </div>
    </div>



    <script>

        const expert_id = {{ request.user.id }};
        const appointment_title = '{{ appointment_title }}';

        function showContent(contentId) {

            $('.expert-content').each(function () {
                $(this).hide()
            })

            $('.profile-menu-item').each(function () {
                $(this).removeClass('selected')
            })

            $('#' + contentId).show()

            if (contentId == 'consultations') {
                getExpertsAppointments()
            }


            var selectedMenuItem = document.querySelector(`.profile-menu-item[data-content="${contentId}"]`);
            selectedMenuItem.classList.add('selected');
        }


        let appointments = []


        function getExpertsAppointments() {
            $.ajax({
                url: '/appointment/list/expert/' + expert_id + '/json',
                type: 'GET',
                data: {},
                success: function (response) {
                    createEventCalendar(response.data);
                    appointments = response.data;
                }
            });
        }

        function loadAppointment(appointmentId) {
            const modalBody = $('#appointmentTableBody');

            const appointment = appointments.find(appointment => appointment.id == appointmentId);

            if (!appointment) {
                return;
            }

            modalBody.html(`

                <div style="display: flex">

                    <div style="display:flex; flex-direction:column;width:20%;gap:20px">
                        <div>Дата:</div>
                        <div>Время:</div>
                        <div>Имя:</div>
                        <div>Zoom:</div>
                        <div>Статус:</div>
                        <div>Time Created:</div>
                    </div>

                    <div style="display:flex; flex-direction:column;gap:20px; width:80%">
                        <div>${moment(appointment.appointment_date).format("DD.MM.YYYY")}</div>
                        <div>${moment(appointment.appointment_time, "HH:mm:ss").format("HH:mm")}</div>
                        <div>${appointment.client.last_name} ${appointment.client.first_name} </div>
                        <div><a href="#">ZOOMLINK</a> </div>
                        <div>
                            <div style="color: ${getStatusColor(appointment.status)};">
                                ${getStatusText(appointment.status)}
                            </div>
                        </div>
                        <div style="display:flex; align-items:center; justify-content: space-between;">
                            <div> ${moment(appointment.created_time).format("DD.MM.YY HH:mm")} </div>
                            <div style="display: flex;align-items: center; ">
                                <div>&nbsp; time left to confirm purchase : &nbsp;</div>
                                <div id="countdownTimer" style="width: 120px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `);

            const createdTime = moment(appointment.created_time);
            const TEN_MINUTES = 10 * 60 * 1000; //10 min in millisceonds

            //clears the other countdown, so there is no gltiches
            clearInterval(window.countdownInterval);

            window.countdownInterval = setInterval(() => {
                const elapsedTime = moment().diff(createdTime);
                const remainingTime = TEN_MINUTES - elapsedTime;


                if (remainingTime <= 0) {
                    clearInterval(window.countdownInterval);
                    renderExpiredButton();
                } else {
                    renderCountdownButton(remainingTime);
                }
            }, 1000);

            function renderCountdownButton(remainingTime) {
                const minutes = Math.floor(remainingTime / 60000);
                const seconds = Math.floor((remainingTime % 60000) / 1000);
                const formattedTime = `${padZero(minutes)}:${padZero(seconds)}`;
                $('#countdownTimer').html(`<button type="button" class="btn btn-success">${formattedTime}</button>`);
            }

            function renderExpiredButton() {
                $('#countdownTimer').html(`<button type="button" class="btn btn-danger">Time expired</button>`);
            }

            function getStatusColor(status) {
                return status === 0 ? '#0dcaf0' : (status === 1 ? '#e3aa00' : (status === 2 ? 'red' : (status === 3 ? 'brown' : 'green')));
            }

            function getStatusText(status) {
                return status === 0 ? 'New' : (status === 1 ? 'Confirmed' : (status === 2 ? 'Declined' : (status === 3 ? 'Cancelled' : 'Paid')));
            }

            function padZero(num) {
                return num < 10 ? `0${num}` : num;
            }
        }


        function createCalendarEvents(appointments) {
            return appointments.map((appointment) => {
                const clientID = `/experts/${appointment.client.id}`;
                const titleHTML = `
                    <div style="display:flex; flex-wrap: wrap;width: 100%;justify-content: space-between;">
                        <span>${appointment_title}</span>
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#exampleModal" style="width:125px; height:25px"
                            onclick="loadAppointment(${appointment.id})">
                            View details
                        </button>
                    </div>
                `;

                let eventColor;
                switch (appointment.status) {
                    case 0:
                        eventColor = "#0dcaf0"; //new
                        break;
                    case 1:
                        eventColor = "#e3aa00"; //confirm
                        break;
                    case 2:
                        eventColor = "red"; //declined
                        break;
                    case 3:
                        eventColor = "brown"; //cancel
                        break;
                    case 4:
                        eventColor = "green"; //paid
                        break;
                }

                return {
                    start: appointment.appointment_date + " " + moment(appointment.appointment_time, "HH:mm:ss").format("HH:mm"),
                    end: appointment.appointment_date + " " + moment(appointment.appointment_time, "HH:mm:ss").add(1, "hours").format("HH:mm"),
                    resourceId: 1,
                    title: { html: titleHTML },
                    color: eventColor,
                };
            });
        }




        let ec;

        function createEventCalendar(appointments) {
            let events = createCalendarEvents(appointments);
            console.log("events", events);
            $('#event-calendar').html('');
            ec = new EventCalendar(document.getElementById('event-calendar'), {
                view: 'timeGridWeek',
                headerToolbar: {
                    start: 'prev,next today',
                    center: 'title',
                    end: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek resourceTimeGridWeek'
                },
                events: events,
        <!--        slotDuration: '01:00:00', -->
        <!--        slotLabelInterval: { hours: 1 }, -->
                slotMinTime: '07:00:00',
                slotMaxTime: '18:00:00',
                buttonText: {
                    timeGridDay: 'день',
                    timeGridWeek: 'неделя',
                    dayGridMonth: 'месяц',
                    today: 'сегодня',
                    listWeek: 'список'
                },
                locale: 'ru',
        <!--        datesSet: function(dates) {-->
        <!--            if (ec) {-->
        <!--                // get start and end dates-->
        <!--                let startDate = dates.start;-->
        <!--                let endDate = dates.end;-->

        <!--                let filteredEvents = events.filter(event => {-->
        <!--                    let eventDate = new Date(event.start);-->
        <!--                    return eventDate >= startDate && eventDate <= endDate;-->
        <!--                });-->

        <!--                // updates calendar-->
        <!--                ec.setOption('events', filteredEvents);-->
        <!--                console.log("filteredEvents", filteredEvents);-->
        <!--            } else {-->
        <!--                console.error("not working");-->
        <!--            }-->
        <!--        }-->
            });

            console.log("Inner HTML of ec-title:", $('.ec-title').html());
        }





        $(function () {

            showContent('articles');

            var currentUrl = window.location.pathname;
            var menuItems = document.getElementsByClassName('profile-menu-item');

            for (var i = 0; i < menuItems.length; i++) {
                var contentId = menuItems[i].getAttribute("data-content");
                var href = `#${contentId}`;

                if (currentUrl.includes(href)) {
                    menuItems[i].classList.add('selected');
                    showContent(contentId);
                    break;
                }
            }
        });

    </script>
{% endblock %}
