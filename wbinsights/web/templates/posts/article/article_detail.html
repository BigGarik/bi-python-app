{% extends 'base123.html' %}
{% load static %}
{% load comments %}
{% load comments_xtd %}
{% load web_tags %}
{% load vote %}
{% block center_col %}
{% load hitcount_tags %}
{% load i18n %}

{% block extra_static %}
    <link rel="stylesheet" href="{% static 'web/css/article_detail.css' %}">
    <style>
        * {
            text-indent: 0 !important;
        }
    </style>
{% endblock %}

<div class="element-container">

    {% trans "BackButtonLabel" as back_text %}
    {% back_button "article_list" back_text %}


    <div style="display: flex; justify-content: space-between">
        <div class="list-publish-date">
            <div><i class="bi bi-calendar2-week" style="color:#a9b4ca;font-size: 16px"></i></div>
            <div>&nbsp; {{ article.time_create|custom_time_display }}</div>
        </div>

        {% if user.is_authenticated and user == article.author %}
            <div class="manage-buttons" style="display: flex; gap: 15px ">
                <a href="{% url 'article_edit' slug=article.slug %}" style="transform: scale(1.2)">
                    <i class="bi bi-pencil"></i>
                </a>
                <a href="#" style="transform: scale(1.2)" data-bs-toggle="modal" data-bs-target="#deleteArticleModal">
                    <i class="bi bi-trash"></i>
                </a>
            </div>
        {% endif %}

    </div>

    <div class="basepost-title">{{ article.title }}</div>


    <style>
        {{ article.styles|safe }}
    </style>

    <div class="basepost-content-cont">
        {% autoescape off %}
        {{ article.content }}
        {% endautoescape %}
    </div>


    <div style="display: flex;justify-content: space-between;align-items: center;margin: 10px 0 10px 0;">
        <div class="voting">
            <button class="like-btn {% vote_exists article user as vote_status %}{% if vote_status %}liked{% endif %}"
                    data-model="web.article" data-id="{{ object.id }}">

                {#                <i class="bi bi-hand-thumbs-up" style="width: 24px; height: 24px"></i>#}
                {#                <i class="bi bi-hand-thumbs-up-fill" style="width: 24px; height: 24px"></i>#}
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                     class="feather feather-thumbs-up">
                    <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path>
                </svg>
                <span class="like-count">{% vote_count article %}</span>
            </button>
        </div>
        <div class="comments-andshare-cont">
            <div class="list-comments">
                <i class="bi bi-eye" style="font-size: 16px" onclick="alert('in progress')"></i>
                <span>{% get_hit_count for article %}</span>
            </div>
            <a href="{{ article.get_absolute_url }}#comments" class="list-comments" style="text-decoration: none;">
                {% include "components/comment_icon.html" %}
                {% get_comment_count for article as comment_count %}
                <span class="list-comments">&nbsp;{{ comment_count }}</span>
            </a>

            {% with request.scheme|add:"://"|add:request.get_host|add:"/articles/"|add:article.slug as article_url %}
                {% social_share_buttons article_url article.title article.pk %}
            {% endwith %}
        </div>
    </div>

    {% include "components/comments.html" with id="comments" %}


</div>

<!-- Modal -->
<div class="modal fade" id="deleteArticleModal" tabindex="-1" aria-labelledby="deleteArticleModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteArticleModalLabel">Подтверждение удаления</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% include "posts/article/article_confirm_delete.html" with article=article %}
            </div>
        </div>
    </div>
</div>


<script>
    document.querySelectorAll('.like-btn').forEach(button => {
        button.addEventListener('click', function () {
            const modelName = this.dataset.model;
            const objectId = this.dataset.id;
            const likeCount = this.querySelector('.like-count');
            const isLiked = this.classList.contains('liked');

            fetch(`/vote/${modelName}/${objectId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `action=up`
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        if (data.action === 'liked') {
                            this.classList.add('liked');
                        } else {
                            this.classList.remove('liked');
                        }
                        likeCount.textContent = data.count;
                    }
                });
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
