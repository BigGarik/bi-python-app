{% extends 'base12.html' %}

{% load static %}

{% block title %}
Создание статьи
{% endblock %}

{% block center_col %}
<link rel="stylesheet" href="//unpkg.com/grapesjs/dist/css/grapes.min.css">
<script src="//unpkg.com/grapesjs"></script>
<link rel="stylesheet" href="{% static 'web/css/article_add.css' %}">

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

<style>
    .sc-189fa0a-0 insmih {
      margin:0px
    }

    @media (max-width: 768px ) {

      .col-add-article{
        padding:0px !important ;
      }


  }

</style>

<div style="display:flex">

    <div class="col-md-8 col-add-article">

        <div style="display:flex; flex-direction: column; margin-bottom: 20px; background-color:white; padding: 20px; border-radius: 15px">

            <div class="global-back-btn">

                <span class="global-back-btn" onclick="goBack()" style="cursor:pointer">
                  <i class="bi bi-chevron-left" style="scale:1"></i> &nbsp;Назад
                </span>

            </div>

            <!--            <form method="post" enctype="multipart/form-data">-->
            <!--                {% csrf_token %}-->
            <!--                {{ form.as_p }}-->
            <!--                <button type="submit" class="btn btn-success">Update Article</button>-->
            <!--            </form>-->

            <!--            {% if object %}-->
            <!--                <div>{{ object.title }}</div>-->
            <!--            {% else %}-->
            <!--                <div>no article found</div>-->
            <!--            {% endif %}-->

            {{form.title}}
            {{form.description}}
            {{ form.title.value }}


            <input type="text" id="title" name="title" class="article-add-title" placeholder="Article Title"
                   value="{{ form.title.value }}"> </input>

            <div style="position: relative;">
                <textarea id="description" name="description" class="article-add-desc-cont"
                          placeholder="Short article description" maxlength="1000" style="resize: none;">{{form.description.value}}</textarea>
                <div id="char-count" style="position: absolute;bottom: 10px;right: 10px;"></div>
            </div>


            <div style="position: relative;">
                <div class="image-upload-container">
                    <input type="file" id="main_img" name="main_img" accept="image/*"
                           onchange="handleFileSelect(event)">
                    <div id="imageContainer" class="image-container">
                        <img id="uploadedImage" src="#" alt="Uploaded Image" style="display: none;">
                        <div id="imagePlaceholder" class="image-placeholder">Drop image here or click to upload</div>
                    </div>
                </div>
            </div>


            <div id="gjs" style="min-height: 300px;"></div>

        </div>

    </div>

    <div class="col-md-4" style="padding:20px;">

        <div class="article-add-right-btns">

            <div class="article-settings">
                <span>Настройки</span>
                <span><i class="bi bi-trash" style="cursor:pointer"></i> Очистить всё</span>
            </div>

            <span class="article-add-desc">
                Перетаскивайте или нажимайте на элементы, чтобы добавить их в редактор
            </span>

            <div id="blocks"></div>

            <hr class="solid"/>

            <div class="choose-catagory">
                <span class="span-article-add-catagory">Категория:</span>
                <div class="dropdown">
                    <button id="categoryDropdownBtn" class="btn btn-secondary dropdown-toggle article-add-dropdown"
                            type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Выберите категорию
                    </button>
                    <ul class="dropdown-menu article-add-category-drop" style="padding:0px">
                        {% for cat in categories %}
                        <li class="category-item" style="padding: 5px 10px 5px 10px"
                            onclick="selectCategory('{{ cat }}')">
                            {{ cat }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div class="choose-tags" style="margin-top: 20px;">
                <span class="article-add-choose-tags">Выберите теги:</span>
                <select id="tagSelect" class="form-select" multiple="multiple" style="width: 100%;">
                    <option value="tag1">IT</option>
                    <option value="tag2">Finance</option>
                    <option value="tag3">Business</option>
                    <option value="tag4">Banks</option>
                    <option value="tag5">Economics</option>
                    <option value="tag6"></option>
                </select>
            </div>

            <button type="submit" class="btn btn-success" style="margin-top:20px" onclick="saveArticle()">Опубликовать
            </button>

        </div>

    </div>

</div>

<script>
    var csrftoken = '{{ csrf_token }}';

    const editor = grapesjs.init({
      container: '#gjs',
      fromElement: true,
      height:'auto',
      width: 'auto',
      storageManager: {
        type: 'local',
        autoload: false,
        autosave: true,
        stepsBeforeSave: 1,
        id: 'gjs',
      },
      panels: { defaults: [] },
      blockManager: {
        appendTo: '#blocks',
        blocks: [
          {
            id: 'sectionh5',
            label: ' <div class ="t-class-comps">T1</div> <b style="color: #a5b1c8;">Большой Заголовок</b>',
            attributes: { class: 'gjs-block-section' },
            content: `
                <h1 style="font-family: sans-serif;">Insert large title text here</h1>
            `,
          },
          {
            id: 'sectionh3',
            label: ' <div class ="t-class-comps">T3</div> <b style="color: #a5b1c8;">Средний Заголовок</b>',
            attributes: { class: 'gjs-block-section' },
            content: `
                <h3 style="font-family: sans-serif;">Insert medium title text here</h3>
            `,
          },
          {
            id: 'sectionh1',
            label: ' <div class ="t-class-comps">T5</div> <b style="color: #a5b1c8;">Маленький Заголовок</b>',
            attributes: { class: 'gjs-block-section' },
            content: `
                <h4 style="font-family: sans-serif;">Insert small title text here</h4>
            `,
          },
          {
            id: 'text',
            label: '<i class="bi bi-card-text" style="color: #a5b1c8; scale: 3; margin-bottom: 10px !important;"></i> <b style="color: #a5b1c8;">Текст</b>',
            content: '<div data-gjs-type="text"  style=" font-family: sans-serif;">Insert your text here</div>',
          },
          {
            id: 'image',
            label: '<i class="bi bi-card-image" style="color: #a5b1c8; scale: 3; margin-bottom: 10px !important; "></i> <b style="color: #a5b1c8;">Изображение</b>',
            select: true,
            content: '<img src="placeholder-image.jpg" alt="Placeholder Image" style="max-width: 100%; height: auto; margin-top:5px;margin-bot:5px">',
            activate: true,
          },
          {
            id:'list',
            label: '<i class="bi bi-list" style="color: #a5b1c8; scale: 3; margin-bottom: 10px !important;"></i> <b style="color: #a5b1c8;">Список</b>',
            content : '<ul><li style="padding : 5px 0 5px 0;font-family: sans-serif;">Item 1<li style=" font-family: sans-serif;">Item 2</li><li style=" margin: 5px 0 5px 0;font-family: sans-serif;">Item 3</li><li style=" margin: 5px 0 5px 0;font-family: sans-serif;">Item 4</li>'
          },
          {
            id: 'hr',
            label: '<i class="bi bi-dash" style="color: #a5b1c8; scale: 3; margin-bottom: 10px !important;"></i> <b style="color: #a5b1c8; font-family: sans-serif;">Горизонтальная линия</b>',
            content: '<hr>',
          },
          {
            id: 'line_break',
            label: '<i class="bi bi-arrows-expand" style="color: #a5b1c8;margin-bottom: 10px;scale: 2;"></i> <b style="color: #a5b1c8; font-family: sans-serif;">Разделитель</b>',
            content: '<div style="margin-bottom: 10px;">&nbsp;</div>',
          }

        ]
      },
    });

    editor.on('load', () => {
      const gjsContainer = document.getElementById('gjs');
      if (gjsContainer) {
        gjsContainer.style.overflow = 'visible';
        gjsContainer.style.height = '100%';
        gjsContainer.style.minHeight = '1000px';
        gjsContainer.style.padding = '10px';
      }
    });

    //--------------------------------------------------------------------------------------------------------//

    function selectCategory(category) {
      const categoryDropdownBtn = document.getElementById('categoryDropdownBtn');
      categoryDropdownBtn.innerText = category;
    }

    function saveArticle() {
      const editorContent = editor.getHtml();
      console.log('editorContent' ,editorContent)
      const title = document.getElementById('title').value;
      const description = document.getElementById('description').value;
      const selectedCategory = document.getElementById('categoryDropdownBtn').innerText.trim();
      const imageFileInput = document.getElementById('main_img');

      if (!selectedCategory || selectedCategory === 'Выберите категорию') {
          alert('Please select a category.');
          return;
      }

      const formData = new FormData();
      formData.append('title', title);
      formData.append('content', editorContent);
      formData.append('description', description);
      formData.append('category', selectedCategory);

      if (imageFileInput && imageFileInput.files.length > 0) {
          const imageFile = imageFileInput.files[0];
          formData.append('main_img', imageFile);
      }

      fetch('/articles/add/', {
          method: 'POST',
          headers: {
              'X-CSRFToken': csrftoken,
          },
          body: formData,
      })
      .then(response => {
          if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
          }
          return response.text();
      })
      .then(data => {
          if (data.startsWith('<')) {
              console.log('Received HTML response:', data);
          } else {
              const dataObj = JSON.parse(data);
              console.log('Response:', dataObj);
              window.location.href = '/' + dataObj.toUrl;
          }
      })
      .catch(error => console.error('Error:', error));
    }

    function clearEditorContent() {
      editor.setComponents('');
    }

    document.addEventListener('DOMContentLoaded', function () {
      const clearButton = document.querySelector('.bi-trash');
      if (clearButton) {
        clearButton.addEventListener('click', function () {
          const isConfirmed = confirm('ARE YOU SURE??');
          if (isConfirmed) {
            clearEditorContent();
          }
        });

        clearButton.addEventListener('mouseover', function () {
          clearButton.style.color = 'red';
        });

        clearButton.addEventListener('mouseout', function () {
          clearButton.style.color = '';
        });
      }
    });

    function goBack() {
      window.history.back();
    }

    // dropdown
    $(document).ready(function() {
      $('#tagSelect').select2({
        maximumSelectionLength: 3,
        language: {
          maximumSelected: function (e) {
            return `Cant choose more than ${e.maximum} tags`;
          }
        }
      });
    });

    //selected tags
    $('#tagSelect').on('select2:select', function (e) {
      const selectedTag = e.params.data.text;
      displaySelectedTag(selectedTag);
    });

    function displaySelectedTag(tag) {
      const tagContainer = document.getElementById('selectedTags');
      const tagElement = document.createElement('span');
      tagElement.innerHTML = `<span>${tag} <button type="button" onclick="removeTag('${tag}')" class="btn btn-sm btn-danger">X</button></span>`;
      tagContainer.appendChild(tagElement);
    }

    function removeTag(tag) {
      //remove selected tags
      const tagContainer = document.getElementById('selectedTags');
      tagContainer.querySelectorAll('span').forEach(tagElement => {
        if (tagElement.innerText.includes(tag)) {
          tagElement.remove();
        }
      });
    }

   /* const textarea = document.getElementById('article-desc');
    const charCount = document.getElementById('char-count');

    textarea.addEventListener('input', function() {
        const remainingChars = 255 - textarea.value.length;
        charCount.textContent = remainingChars + ' characters remaining';
    });
    */

    document.getElementById('main_img').addEventListener('change', handleFileSelect);

    document.getElementById('imageContainer').addEventListener('dragover', allowDrop);
    document.getElementById('imageContainer').addEventListener('drop', handleDrop);

    function allowDrop(event) {
      event.preventDefault();
    }

    function handleDrop(event) {
      event.preventDefault();
      const file = event.dataTransfer.files[0];
      handleFileSelect(file);
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = function (e) {
        document.getElementById('uploadedImage').src = e.target.result;
        document.getElementById('uploadedImage').style.display = 'block';
        document.getElementById('imagePlaceholder').style.display = 'none';
      };
      reader.readAsDataURL(file);
    }


</script>

{% endblock %}
