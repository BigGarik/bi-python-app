{% load static %}
{% load i18n %}
{% load web_tags %}

<style>
    .card-css {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 200px;
    }

    .no-arrow {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background: none;
        background-position: right;
    }

    @media (max-width: 768px) {
        .page-link {
            font-size: 12px !important;
        }
        .smallBtnProf {
            font-size: 12px !important;
            justify-content: center !important;
        }
    }
</style>

{% if request.path == '/profile' and request.user.is_authenticated and request.user.profile.type == 1 %}
    <a href="{% url 'project_add' %}" class="btn btn-primary" style="margin-bottom: 10px" role="button"
       aria-pressed="true">Добавить проект</a>
{% endif %}

{% if projects %}

    {% get_all_categories as categories %}
    <form method="get" id="filter-form" class="mb-4 py-2">
        <div class="form-group">
            <input type="text" name="name" id="name" class="form-control" placeholder="Search Project By Name"
                   value="{{ request.GET.name }} ">
        </div>
        <div class="smallBtnProf py-2" style="display: flex; justify-content: flex-end; gap: 10px;">
            <div class="form-group">
                <div class="dropdown mb-3">
                    <button type="button" class="btn btn-secondary dropdown-toggle smallBtnProf" data-bs-toggle="dropdown">
                        {% if request.GET.category %}
                            {% trans 'Category' %}:
                            {% for category in categories %}
                                {% if category.id|stringformat:"s" == request.GET.category %}
                                    {{ category.name }}
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            {% trans 'Filter by category' %}: {% trans 'All' %}
                        {% endif %}
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="?{{ get_params.urlencode }}">{% trans 'All' %} {% trans 'Categories' %}</a></li>
                        {% for category in categories %}
                            <li>
                                <a class="dropdown-item{% if request.GET.category == category.id|stringformat:"s" %} active{% endif %}"
                                   href="?{{ get_params.urlencode }}&category={{ category.id }}">
                                    {{ category.name }}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <div class="form-group">
                <div class="dropdown">
                    <button id="pageSizeDropdown" class="btn btn-secondary dropdown-toggle smallBtnProf" type="button" data-bs-toggle="dropdown">
                        {% trans 'Projects per page' %}:
                        {% if request.GET.page_size %}
                            {{ request.GET.page_size }}
                        {% else %}
                            5 <!-- Default value -->
                        {% endif %}
                    </button>
                    <ul class="dropdown-menu">
                        {% with page_cnt_array='5 10 20 50 100 500' %}
                            {% for item in page_cnt_array.split %}
                                <li><a class="dropdown-item{% if request.GET.page_size ==  item %} active{% endif %}"
                                       href="?page_size={{ item }}{% for key, value in request.GET.items %}{% if key != 'page_size' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ item }}</a></li>
                            {% endfor %}
                        {% endwith %}
                    </ul>
                </div>
            </div>
        </div>
        {% for key, value in request.GET.items %}
            {% if key != 'name' %}
                <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endif %}
        {% endfor %}
    </form>

    <div class="project-list d-none d-md-flex" style="display:flex; gap: 10px; flex-wrap: wrap">
        {% for project in projects %}
            <div class="card card-body border-dark1 text-dark card-css mb-3"
                 style="width:19%; max-width:19%; cursor: pointer;"
                 onclick="showProjectDetails('{{ project.id }}')">
                <h6 class="card-title" style="font-weight: bold">{{ project.name }}</h6>
                <h6 class="card-title">{{ project.year }} г.</h6>
                <h6 class="card-title">
                    {{ project.category.all | join:", " }}
                </h6>
                <div class="project-icon-main-cont">
                    <div class="project-icon-cont">
                        <i class="bi bi-eye" style="font-size: 20px" onclick="alert('in progress')"></i> 46
                    </div>
                    <div class="project-icon-cont">
                        <i class="bi bi-hand-thumbs-up" style="font-size: 20px"
                           onclick="alert('in progress')"></i>
                        {{ project.votes.count }}
                    </div>
                </div>
            </div>
            <div id="details-desktop-{{ project.id }}" class="card border-dark mb-3 project-details-modal-content"
                 style="display: none; padding: 10px;">
                <div class="row" style="margin-bottom: 10px;">
                    <div class="col-4">
                        <div class="client-year-cont">
                            <div class="project-ccompany projects-flex">
                                <span style="min-width: 75px;"> Клиент:  </span>
                                <span> {{ project.company }} </span>
                            </div>
                            <div class="project-year projects-flex">
                                <span style="min-width: 75px;"> Год: </span>
                                <span> {{ project.year }} </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-8">
                        <div class="edit-project-search-bar global-border-radius">
                            <h3 style="margin-bottom: 0px;font-size: 22px;">{{ project.name }}</h3>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        <div class="jumbotron jumbotron-fluid jumbo-styles" style="flex-direction: column">
                            <div class="project-members-caption" style="justify-content: flex-start">Цели проекта:</div>
                            <div class="project-goals">{{ project.goals }}</div>
                        </div>
                    </div>
                    <div class="col-8">
                        <div class="jumbotron jumbotron-fluid jumbo-styles">
                            <div class="container">
                                <div class="project-members-caption">Ключевые результаты проекта:</div>
                                <div class="project-key-results">
                                    <ul style="gap: 5px; display: flex; flex-direction: column;">
                                        {% for key_result in project.key_results %}
                                            <li>{{ key_result }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            <div class="container" style="display: flex; flex-direction: column; margin-right: 0px;">
                                <div class="project-members-caption">Участники:</div>
                                <div class="project-members">
                                    {% for member in project.members.all %}
                                        <a href="/experts/{{ member.id }}">
                                            <img class="member-img" src="{{ member.profile.avatar.url }}"
                                                 title="{{ member.last_name }} {{ member.first_name }}" alt="
                                                    {{ member.first_name|slice:":1" }}{{ member.last_name|slice:":1" }}"
                                                 style="width: 40px; height: 40px;">
                                        </a>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% if request.user.is_authenticated and request.user.profile.type == 1 and request.path == '/profile' %}
                    <div style="display: flex; justify-content: flex-end; gap: 5px; margin-top: 10px;">
                        <a href="/expert/project/{{ project.slug }}/edit/"
                           class="btn btn-primary btn-sm">Редактировать</a>
                        <a href="/expert/project/{{ project.slug }}/delete/"
                           class="btn btn-danger btn-sm">Удалить</a>
                    </div>
                {% endif %}
            </div>
        {% endfor %}
    </div>

    <!-- mobile version of modal and cards -->

    <div class="project-list d-md-none" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: space-evenly">
        {% for project in projects %}
            <div class="card card-body border-dark1 text-dark card-css mb-3"
                 style="width:45%; max-width:45%; cursor: pointer;"
                 onclick="showProjectDetailsMobile('{{ project.id }}')">
                <h6 class="card-title" style="font-weight: bold">{{ project.name }}</h6>
                <h6 class="card-title">{{ project.year }} г.</h6>
                <h6 class="card-title">
                    {{ project.category.all | join:", " }}
                </h6>
                <div class="project-icon-main-cont">
                    <div class="project-icon-cont">
                        <i class="bi bi-eye" style="font-size: 20px" onclick="alert('in progress')"></i> 46
                    </div>
                    <div class="project-icon-cont">
                        <i class="bi bi-hand-thumbs-up" style="font-size: 20px"
                           onclick="alert('in progress')"></i>
                        46
                    </div>
                </div>
            </div>


            <div id="details-mobile-{{ project.id }}" class="card border-dark mb-3 project-details-modal-content" style="display: none; padding: 10px;">
                <div class="row" style="margin-bottom: 10px;">
                    <div class="col-12">
                        <div class="edit-project-search-bar global-border-radius">
                            <h3 style="margin-bottom: 0px;font-size: 22px;">{{ project.name }}</h3>
                        </div>
                    </div>
                </div>
                <div class="row" style="margin: 10px 0px 10px 0;">

                    <div class="col-12">
                        <div class="client-year-cont" style="display: flex;flex-direction: row;justify-content: space-evenly;">
                            <div class="project-ccompany projects-flex">
                                <span > Клиент:  </span>
                                <span> &nbsp; {{ project.company }} </span>
                            </div>
                            <div class="project-year projects-flex">
                                <span > Год: </span>
                                <span> &nbsp; {{ project.year }} </span>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="row jumbotron jumbotron-fluid jumbo-styles" style="margin: 10px 0px 10px 0;">
                    <div class="col-12" style="padding: 0; ">
                        <div class="project-members-caption" style="justify-content: flex-start;">Цели проекта:</div>
                    </div>
                    <div class="col-12" style="padding: 0; ">
                        <div class="project-goals">{{ project.goals }}</div>
                    </div>

                </div>

                <div class="row" >

                    <div class="col-12">
                        <div class="jumbotron jumbotron-fluid jumbo-styles">
                            <div class="container">
                                <div class="project-members-caption">Ключевые результаты проекта:</div>
                                <div class="project-key-results">
                                    <ul style="gap: 5px; display: flex; flex-direction: column;">
                                        {% for key_result in project.key_results %}
                                            <li>{{ key_result }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            <div class="container" style="display: flex; flex-direction: column; margin-right: 0px;">
                                <div class="project-members-caption">Участники:</div>
                                <div class="project-members">
                                    {% for member in project.members.all %}
                                        <a href="/experts/{{ member.id }}">
                                            <img class="member-img" src="{{ member.profile.avatar.url }}"
                                                 title="{{ member.last_name }} {{ member.first_name }}" alt="
                                                    {{ member.first_name|slice:":1" }}{{ member.last_name|slice:":1" }}"
                                                 style="width: 40px; height: 40px;">
                                        </a>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% if request.user.is_authenticated and request.user.profile.type == 1 and request.path == '/profile' %}
                    <div style="display: flex; justify-content: flex-end; gap: 5px; margin-top: 10px;">
                        <a href="/expert/project/{{ project.slug }}/edit/" class="btn btn-primary btn-sm">Редактировать</a>
                        <a href="/expert/project/{{ project.slug }}/delete/" class="btn btn-danger btn-sm">Удалить</a>
                    </div>
                {% endif %}
            </div>
        {% endfor %}
    </div>



    {% if projects.paginator.num_pages > 1 %}
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center d-none d-md-flex">
                {% if projects.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                           aria-label="First">
                            <span aria-hidden="true">&laquo; {% trans 'First' %}</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ projects.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                           aria-label="Previous">
                            <span aria-hidden="true">&lsaquo; {% trans 'Previous' %}</span>
                        </a>
                    </li>
                {% else %}
                    <li class="page-item disabled">
                        <span class="page-link" aria-hidden="true">&laquo; {% trans 'First' %}</span>
                    </li>
                    <li class="page-item disabled">
                        <span class="page-link" aria-hidden="true">&lsaquo; {% trans 'Previous' %}</span>
                    </li>
                {% endif %}
                <li class="page-item disabled">
                    <span class="page-link">
                        {% trans 'Page' %} {{ projects.number }} of {{ projects.paginator.num_pages }}
                    </span>
                </li>
                {% if projects.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ projects.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                           aria-label="Next">
                            <span aria-hidden="true">{% trans 'Next page' %} &rsaquo;</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ projects.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                           aria-label="Last">
                            <span aria-hidden="true">{% trans 'Last page' %} &raquo;</span>
                        </a>
                    </li>
                {% else %}
                    <li class="page-item disabled">
                        <span class="page-link" aria-hidden="true">{% trans 'Next page' %} &rsaquo;</span>
                    </li>
                    <li class="page-item disabled">
                        <span class="page-link" aria-hidden="true">{% trans 'Last page' %} &raquo;</span>
                    </li>
                {% endif %}
            </ul>
        </nav>

        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center d-md-none">
                {% if projects.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ projects.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                           aria-label="Previous">
                            <span aria-hidden="true">&lsaquo; {% trans 'Previous' %}</span>
                        </a>
                    </li>
                {% else %}
                    <li class="page-item disabled">
                        <span class="page-link" aria-hidden="true">&lsaquo; {% trans 'Previous' %}</span>
                    </li>
                {% endif %}
                <li class="page-item">
                    <select class="page-link form-select no-arrow" style="border-radius: 0px;" onchange="location = this.value;">
                        {% for page_num in projects.paginator.page_range %}
                            <option value="?page={{ page_num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                                {% if page_num == projects.number %}selected{% endif %}>
                                {% trans 'Page' %} {{ page_num }} {% trans 'out of' %} {{ projects.paginator.num_pages }}
                            </option>
                        {% endfor %}
                    </select>
                </li>
                {% if projects.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ projects.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                           aria-label="Next">
                            <span aria-hidden="true">{% trans 'Next page' %} &rsaquo;</span>
                        </a>
                    </li>
                {% else %}
                    <li class="page-item disabled">
                        <span class="page-link" aria-hidden="true">{% trans 'Next page' %} &rsaquo;</span>
                    </li>
                {% endif %}
            </ul>
        </nav>
    {% endif %}

{% else %}
    <p>User has no projects.</p>
{% endif %}

<div class="modal fade" id="projectDetailsModalDesktop" tabindex="-1" role="dialog"
     aria-labelledby="projectDetailsModalLabelDesktop" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="projectDetailsModalLabelDesktop">{% trans 'Project Details' %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="projectDetailsModalBodyDesktop">
                <!-- details here -->
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="projectDetailsModalMobile" tabindex="-1" role="dialog"
     aria-labelledby="projectDetailsModalLabelMobile" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="projectDetailsModalLabelMobile">{% trans 'Project Details' %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="projectDetailsModalBodyMobile">
                <!-- details here -->
            </div>
        </div>
    </div>
</div>

<script>
    function showProjectDetails(projectId) {
        const projectDetails = document.getElementById(`details-desktop-${projectId}`).innerHTML;
        document.getElementById('projectDetailsModalBodyDesktop').innerHTML = projectDetails;
        $('#projectDetailsModalDesktop').modal('show');
    }

    function showProjectDetailsMobile(projectId) {
        const projectDetails = document.getElementById(`details-mobile-${projectId}`).innerHTML;
        document.getElementById('projectDetailsModalBodyMobile').innerHTML = projectDetails;
        $('#projectDetailsModalMobile').modal('show');
    }

    document.addEventListener("DOMContentLoaded", function () {
        const projectCount = document.querySelectorAll('.project-list .card').length;
        console.log(`Total number of projects: ${projectCount}`);
    });
</script>
