{% extends 'base123.html' %}
{% load web_tags %}
{% load file_filters %}
{% load static %}
{% load i18n %}

{% block center_col %}
    {% block extra_static %}
        <link rel="stylesheet" href="{% static 'css/editUserProject.css' %}">
        <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    {% endblock %}

    <style>
        .select2-container {
            width: 100% !important;
        }

        .select2-container .select2-selection--multiple {
            min-height: 38px;
        }

        .select2-container .select2-selection--single {
            height: 38px;
            padding: 6px 12px;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__rendered li {
            list-style: none;
            display: flex !important;
        }

        .select2-selection.select2-selection--multiple {
            display: flex !important;
        }
    </style>
    <div class="element-container basepost-content-mobile-bottom-padding">
        {% trans "BackButtonLabel" as back_text %}
        {% back_button "profile" back_text %}

        <div class="g-fs-header-20 mb-2">Редактирование проекта: {{ userproject.name }}</div>

        <form enctype="multipart/form-data" id="project-form" method="post">
            {% csrf_token %}

            <!-- Project Name -->
            <div class="mb-2">
                <label for="{{ form.name.id_for_label }}" class="form-label g-fs-14 fw-semibold">
                    {{ form.name.label }}
                </label>
                {{ form.name }}
                {% if form.name.errors %}
                    <div class="invalid-feedback">
                        {{ form.name.errors }}
                    </div>
                {% endif %}
            </div>

            <!-- Project Categories -->
            <div class="mb-2">
                <label for="{{ form.category.id_for_label }}" class="form-label g-fs-14 fw-semibold">
                    {{ form.category.label }}
                </label>
                {{ form.category }}
                {% if form.category.errors %}
                    <div class="invalid-feedback">
                        {{ form.category.errors }}
                    </div>
                {% endif %}
            </div>

            <!-- Company -->
            <div class="mb-2">
                <label for="{{ form.company.id_for_label }}" class="form-label g-fs-14 fw-semibold">
                    {{ form.company.label }}
                </label>
                {{ form.company }}
                {% if form.company.errors %}
                    <div class="invalid-feedback">
                        {{ form.company.errors }}
                    </div>
                {% endif %}
            </div>

            <!-- Year -->
            <div class="mb-2">
                <label for="{{ form.year.id_for_label }}" class="form-label g-fs-14 fw-semibold">
                    {{ form.year.label }}
                </label>
                {{ form.year }}
                {% if form.year.errors %}
                    <div class="invalid-feedback">
                        {{ form.year.errors }}
                    </div>
                {% endif %}
            </div>

            <!-- Goals -->
            <div class="mb-2">
                <label for="{{ form.goals.id_for_label }}" class="form-label g-fs-14 fw-semibold">
                    {{ form.goals.label }}
                </label>
                {{ form.goals }}
                {% if form.goals.errors %}
                    <div class="invalid-feedback">
                        {{ form.goals.errors }}
                    </div>
                {% endif %}
            </div>

            <!-- Key Results -->
            <div class="mb-2">
                <label for="{{ form.key_results_text.id_for_label }}" class="form-label g-fs-14 fw-semibold">
                    {{ form.key_results_text.label }}
                </label>
                {{ form.key_results_text }}
                {% if form.key_results_text.help_text %}
                    <div class="form-text">
                        {{ form.key_results_text.help_text }}
                    </div>
                {% endif %}
                {% if form.key_results_text.errors %}
                    <div class="invalid-feedback">
                        {{ form.key_results_text.errors }}
                    </div>
                {% endif %}
            </div>

            <!-- Project Members -->
            <div class="mb-4">
                <label for="id_members" class="form-label g-fs-14 fw-semibold">Участники проекта:</label>
                <select name="members"
                        id="id_members"
                        multiple
                        class="form-select">
                    {% for member in members %}
                        <option value="{{ member.id }}">{{ member.email }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- File Upload Section -->
            <div class="d-flex align-items-center gap-3 mb-4">
                <div class="g-fs-header-20 mb-0">Файлы проекта:</div>
                <button id="fileInputBtn" class="btn btn-primary btn-sm">Добавить файлы</button>
            </div>

            <!-- File List -->
            <div id="fileList" class="mb-4">
                <ul class="list-unstyled">
                    {% for file in files.all %}
                        <li class="mb-2 loaded-from-server" data-file-id="{{ file.id }}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="text-truncate me-3">
                                    {% if file.file %}
                                        <a href="{{ file.file.url }}" class="text-decoration-none">
                                            {{ file.file.name|filename }}
                                        </a>
                                    {% else %}
                                        <span class="text-muted">Файл отсутствует.</span>
                                    {% endif %}
                                </div>
                                <i class="bi bi-trash fs-5 text-danger" role="button"></i>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            </div>

            <input type="hidden" id="delete_file_ids" name="delete_file_ids" multiple>

            <!-- Submit Button -->
            <div class="d-grid">
                <button type="submit" class="btn btn-primary">Сохранить изменения</button>
            </div>
        </form>

    </div>

    <input type="file" id="fileInput" name="files" multiple style="display: none;">

    <script>
        document.getElementById('fileInputBtn').addEventListener('click', function (event) {
            event.preventDefault();
            document.getElementById('fileInput').click();
        });

        let fileList = [];
        let deletedFileIds = [];

        function updateFileList() {
            const fileListDiv = document.getElementById('fileList');
            let ul = fileListDiv.querySelector('ul');

            ul.querySelectorAll('.new-file').forEach(el => el.remove());

            fileList.forEach(function (file, index) {
                const listItem = document.createElement('li');
                listItem.dataset.fileIndex = index;
                listItem.className = 'mb-2 new-file';

                const wrapperDiv = document.createElement('div');
                wrapperDiv.className = 'd-flex justify-content-between align-items-center';

                const fileNameDiv = document.createElement('div');
                fileNameDiv.className = 'text-truncate me-3';

                const fileLink = document.createElement('a');
                fileLink.href = '#';
                fileLink.className = 'text-decoration-none';
                fileLink.textContent = file.name;
                fileNameDiv.appendChild(fileLink);

                // Create delete button with Bootstrap classes
                const deleteButton = document.createElement('i');
                deleteButton.className = 'bi bi-trash fs-5 text-danger';
                deleteButton.setAttribute('role', 'button');
                deleteButton.style.cursor = 'pointer';
                deleteButton.addEventListener('click', function () {
                    const listItem = this.closest('li');
                    const fileIndex = listItem.dataset.fileIndex;
                    fileList.splice(fileIndex, 1);
                    updateFileList();
                });

                wrapperDiv.appendChild(fileNameDiv);
                wrapperDiv.appendChild(deleteButton);
                listItem.appendChild(wrapperDiv);
                ul.appendChild(listItem);
            });
        }

        document.getElementById('fileInput').addEventListener('change', function () {
            const files = this.files;

            for (let i = 0; i < files.length; i++) {
                fileList.push(files[i]);
            }

            updateFileList();
        });

        document.addEventListener('DOMContentLoaded', function () {
            const deleteButtons = document.querySelectorAll('.bi-trash');

            deleteButtons.forEach(function (deleteButton) {
                deleteButton.addEventListener('click', function () {
                    const listItem = this.closest('li');
                    const fileId = listItem.dataset.fileId;

                    if (fileId) {
                        deletedFileIds.push(fileId);
                        updateDeletedFileIdsInput();
                        listItem.remove();
                    } else {
                        const fileIndex = listItem.dataset.fileIndex;
                        fileList.splice(fileIndex, 1);
                        updateFileList();
                        listItem.remove();
                    }
                });
            });
        });

        function updateDeletedFileIdsInput() {
            const deleteFilesInput = document.getElementById('delete_file_ids');
            deleteFilesInput.value = deletedFileIds;
        }

        document.getElementById('project-form').addEventListener('submit', function (event) {
            event.preventDefault();

            const formData = new FormData(this);

            for (let i = 0; i < fileList.length; i++) {
                formData.append('files', fileList[i]);
            }

            fetch('{% url 'project_edit' userproject.slug %}', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (response.ok) {
                        window.location.href = '{% url 'profile' %}';
                    } else {
                        console.error('Failed to upload files:', response.statusText);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });


        $(document).ready(function () {
            $('#id_category').select2({
                placeholder: "Выберите категории проекта",
                allowClear: true
            });

            $("#id_members").select2({
                ajax: {
                    url: "/expert/search-experts/",
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            query: params.term,
                            page: params.page
                        };
                    },
                    processResults: function (data, params) {
                        return {
                            results: $.map(data.data, function (item) {
                                return {
                                    id: item.id,
                                    text: item.email,
                                    email: item.email,
                                    last_name: item.last_name,
                                    first_name: item.first_name,
                                    profile_photo: item.profile_photo,
                                };
                            })
                        };
                    },
                    cache: true
                },
                templateResult: formatResult,
                templateSelection: formatSelection,
                minimumInputLength: 3,
                placeholder: "Выберите участников проекта",
                allowClear: true
            });

            // Initialize existing members
            var existingMembers = {{ members_json|safe }};
            var $select = $('#id_members');
            $.each(existingMembers, function (i, member) {
                var option = new Option(
                    `${member.last_name} ${member.first_name} (${member.email})`,
                    member.id,
                    true,
                    true
                );
                $(option).data('email', member.email);
                $(option).data('last_name', member.last_name);
                $(option).data('first_name', member.first_name);
                $(option).data('profile_photo', member.profile_photo);
                $select.append(option);
            });
            $select.trigger('change');

            var existingMembers = {{ members_json|safe }};
            var $select = $('#id_members');
            $.each(existingMembers, function (i, member) {
                var option = new Option(member.email, member.id, true, true);
                $select.append(option).trigger('change');
            });
        });

        function formatResult(result) {
            if (!result.id) return result.text;
            return $('<div style="display: flex; align-items: center"><img width="60" height="60" style="padding: 5px; border-radius: 50%;object-fit: cover !important;" src="' + result.profile_photo + '"/>' + result.last_name + ' ' + result.first_name + ' (' + result.email + ')</div>');
        }

        function formatSelection(result) {
            return $('<div style="display: flex; align-items: center">' + (result.last_name || '') + ' ' + (result.first_name || '') + ' (' + (result.email || result.text) + ')</div>');
        }
    </script>

{% endblock %}
