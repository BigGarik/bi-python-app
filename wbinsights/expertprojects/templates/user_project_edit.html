{% extends 'base123.html' %}
{% load web_tags %}
{% load file_filters %}
{% load static %}

{% block center_col %}
{% block extra_static %}
    <link rel="stylesheet" href="{% static 'css/editUserProject.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
{% endblock %}

<style>
    .select2-container {
        width: 100% !important;
    }
    .select2-container .select2-selection--multiple {
        min-height: 38px;
    }
    .select2-container .select2-selection--single {
        height: 38px;
        padding: 6px 12px;
    }
    .select2-container--default .select2-selection--multiple .select2-selection__rendered li {
        list-style: none;
        display: flex !important;
    }
    .select2-selection.select2-selection--multiple {
        display: flex !important;
    }
</style>

<a href="{% url 'profile' %}" class="global-back-btn"><i class="bi bi-chevron-left"></i> &nbsp;Назад</a>
<h2>Редактирование проекта: {{ userproject.name }}</h2>

<form enctype="multipart/form-data" id="project-form" method="post">
    {% csrf_token %}
    {{ form.as_p }}

    <div class="form-group form-group-margin">
        <label for="id_members">Участники проекта:</label>
        <select name="members" id="id_members" multiple class="form-control">
            {% for member in members %}
                <option value="{{ member.id }}">{{ member.email }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="file-upload-container">
        <span class="file-upload-title">Файлы проекта:</span>
        <button id="fileInputBtn" class="btn btn-primary btn-sm file-upload-btn">Добавить файлы</button>
    </div>

    <div id="fileList">
        <ul>
            {% for file in files.all %}
                <li class="file-list-item loaded-from-server" data-file-id="{{ file.id }}">
                    <div class="file-list-details">
                        <div class="file-name">
                            {% if file.file %}
                                <a href="{{ file.file.url }}">{{ file.file.name|filename }}</a>
                            {% else %}
                                Файл отсутствует.
                            {% endif %}
                        </div>
                        <i class="bi bi-trash trash-icon"></i>
                    </div>
                </li>
            {% endfor %}
        </ul>
    </div>

    <input type="hidden" id="delete_file_ids" name="delete_file_ids" multiple>
    <button type="submit" class="btn btn-primary btn-sm">Сохранить изменения</button>
</form>

<input type="file" id="fileInput" name="files" multiple style="display: none;">
<script>
    document.getElementById('fileInputBtn').addEventListener('click', function (event) {
        event.preventDefault();
        document.getElementById('fileInput').click();
    });

    let fileList = [];
    let deletedFileIds = [];

    function updateFileList() {
        const fileListDiv = document.getElementById('fileList');
        let ul = fileListDiv.querySelector('ul');

        ul.querySelectorAll('.new-file').forEach(el => el.remove());

        fileList.forEach(function (file, index) {
            const listItem = document.createElement('li');
            listItem.dataset.fileIndex = index;
            listItem.classList.add('new-file');

            const fileLink = document.createElement('a');
            fileLink.href = file.url ? file.url : '#';
            fileLink.textContent = file.name;

            const deleteButton = document.createElement('i');
            deleteButton.classList.add('bi', 'bi-trash', 'trash-icon');
            deleteButton.style.fontSize = '20px';
            deleteButton.style.cursor = 'pointer';
            deleteButton.addEventListener('click', function () {
                const listItem = this.closest('li');
                const fileIndex = listItem.dataset.fileIndex;
                fileList.splice(fileIndex, 1);
                updateFileList();
            });

            listItem.appendChild(fileLink);
            listItem.appendChild(deleteButton);
            ul.appendChild(listItem);
        });
    }

    document.getElementById('fileInput').addEventListener('change', function () {
        const files = this.files;

        for (let i = 0; i < files.length; i++) {
            fileList.push(files[i]);
        }

        updateFileList();
    });

    document.addEventListener('DOMContentLoaded', function () {
        const deleteButtons = document.querySelectorAll('.trash-icon');

        deleteButtons.forEach(function (deleteButton) {
            deleteButton.addEventListener('click', function () {
                const listItem = this.closest('li');
                const fileId = listItem.dataset.fileId;

                if (fileId) {
                    deletedFileIds.push(fileId);
                    updateDeletedFileIdsInput();
                    listItem.remove();
                } else {
                    const fileIndex = listItem.dataset.fileIndex;
                    fileList.splice(fileIndex, 1);
                    updateFileList();
                    listItem.remove();
                }
            });
        });
    });

    function updateDeletedFileIdsInput() {
        const deleteFilesInput = document.getElementById('delete_file_ids');
        deleteFilesInput.value = deletedFileIds;
    }

    document.getElementById('project-form').addEventListener('submit', function (event) {
        event.preventDefault();

        const formData = new FormData(this);

        for (let i = 0; i < fileList.length; i++) {
            formData.append('files', fileList[i]);
        }

        fetch('{% url 'project_edit' userproject.slug %}', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                window.location.href = '{% url 'profile' %}';
            } else {
                console.error('Failed to upload files:', response.statusText);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });



    $(document).ready(function() {
        $('#id_category').select2({
            placeholder: "Выберите категории проекта",
            allowClear: true
        });

        $("#id_members").select2({
            ajax: {
                url: "/expert/search-experts/",
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        query: params.term,
                        page: params.page
                    };
                },
                processResults: function (data, params) {
                    return {
                        results: $.map(data.data, function (item) {
                            return {
                                id: item.id,
                                text: item.email,
                                email: item.email,
                                last_name: item.last_name,
                                first_name: item.first_name,
                                profile_photo: item.profile_photo,
                            };
                        })
                    };
                },
                cache: true
            },
            templateResult: formatResult,
            templateSelection: formatSelection,
            minimumInputLength: 3,
            placeholder: "Выберите участников проекта",
            allowClear: true
        });

        // Initialize existing members
        var existingMembers = {{ members_json|safe }};
        var $select = $('#id_members');
        $.each(existingMembers, function(i, member) {
            var option = new Option(
                `${member.last_name} ${member.first_name} (${member.email})`,
                member.id,
                true,
                true
            );
            $(option).data('email', member.email);
            $(option).data('last_name', member.last_name);
            $(option).data('first_name', member.first_name);
            $(option).data('profile_photo', member.profile_photo);
            $select.append(option);
        });
        $select.trigger('change');

        var existingMembers = {{ members_json|safe }};
        var $select = $('#id_members');
        $.each(existingMembers, function(i, member) {
            var option = new Option(member.email, member.id, true, true);
            $select.append(option).trigger('change');
        });
    });

    function formatResult(result) {
        if (!result.id) return result.text;
        return $('<div style="display: flex; align-items: center"><img width="70" height="70" style="padding: 5px; border-radius: 50%;object-fit: cover;" src="' + result.profile_photo + '"/>' + result.last_name + ' ' + result.first_name + ' (' + result.email + ')</div>');
    }

    function formatSelection(result) {
        return $('<div style="display: flex; align-items: center">' + (result.last_name || '') + ' ' + (result.first_name || '') + ' (' + (result.email || result.text) + ')</div>');
    }
</script>

{% endblock %}
