{% load web_tags %}


{% if request.path == '/profile' and request.user.is_authenticated and request.user.profile.type == 1 %}
<a href="{% url 'project_add' %}" class="btn btn-primary" style="margin-bottom: 10px" role="button" aria-pressed="true">Добавить
    проект</a>
{% endif %}

<div style="display: none" id="user-projects-container">


    <div style="display:flex; justify-content:space-between; margin-bottom:30px; gap:10px">

        <input type="text" id="project-search-bar" class="lists-search-cont" placeholder="Название проекта">

        <div class="dropdown show">
            <a class="btn btn-secondary dropdown-toggle" href="javascript:void(0)" role="button" id="dropdownMenuLink"
               data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="margin: 0px !important;">
            </a>

            <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                <a class="dropdown-item" href="javascript:void(0)" onclick="loadProjectsByCategory('')">Все </a>

                {% get_all_categories as categories %}
                {% for category in categories %}
                <a class="dropdown-item" href="javascript:void(0)"
                   onclick="loadProjectsByCategory('{{ category.id }}', '{{ category.name }}')">{{ category.name }}</a>
                {% endfor %}
            </div>
        </div>


    </div>

    <div id="id_project_catalog" style="display:flex; justify-content: flex-start; gap: 10px; flex-wrap: wrap"></div>

    <div id="id_project" style="display:flex; flex-direction: column ; padding:10px" class="card border-dark mb-3">

        <div class="row" style="margin-bottom: 10px;">

            <div class="col-4">
                <div class="client-year-cont">
                    <div class="project-customer projects-flex"></div>
                    <div class="project-year projects-flex"></div>
                </div>
            </div>

            <div class="col-8">
                <div class="edit-project-search-bar global-border-radius">
                    <div class="project-name">
                    </div>
                </div>
            </div>

        </div>

        <div class="row">
            <div class="col-4">
                <div class="jumbotron jumbotron-fluid jumbo-styles">
                    <div class="container">
                        <div class="project-members-caption">Цели проекта:</div>
                        <div class="project-goals"></div>
                    </div>
                </div>
            </div>
            <div class="col-8">
                <div class="jumbotron jumbotron-fluid jumbo-styles">
                    <div class="container">
                        <div class="project-members-caption">Ключевые результаты проекта:</div>
                        <div class="project-key-results"></div>
                    </div>
                    <div class="container"
                         style="display: flex;flex-direction: column;margin-right:0px ">
                        <div class="project-members-caption">Участники:</div>
                        <div class="project-members"></div>


                    </div>
                </div>
            </div>
            {% if request.path == '/profile' and request.user.is_authenticated and request.user.profile.type == 1 %}
            <div style="display: flex;justify-content: flex-end;gap: 5px;margin-top: 10px;">
                <div class="button-proj-edit"></div>
                <div class="button-proj-delete"></div>
            </div>
            {%endif%}

        </div>

    </div>

    <div style="display: none" id="user-project-no-cat">No projects found</div>

</div>

<div style="display: none" id="user-projects-container-no-projects">No projects found</div>

<button id="load-more-btn">Load more</button>


<style>

    .card-custom{
        width: 200px;
        height: 250px;
        display: flex;
        flex-direction: column;
        justify-content: space-evenly;
    }

</style>

<script>
    let searchTimeout;
    let userProjects = [];
    let page_number = 0;
    const recornd_on_page = 10;

    $(function () {
        $('#load-more-btn').click(function () {

            page_number = page_number + 1;
            console.log(page_number)
            getUsersProjects('')
        })
    })

    function loadProject(project_idx) {
        $('.card.border-dark.mb-3').removeClass('selectedProj');
        $(`.card.border-dark.mb-3:eq(${project_idx})`).addClass('selectedProj');

        const selectedProject = userProjects[project_idx];
        console.log('selectedProject', selectedProject)

        $('.project-customer').html('Клиент:&nbsp;' + selectedProject.customer.name);
        $('.project-year').html('Год:&nbsp;' + selectedProject.year);
        $('.project-goals').html(selectedProject.goals);
        $('.project-name').html(selectedProject.name);

        const projectKeyResultsCont = $('.project-key-results');
        projectKeyResultsCont.html('');
        const keyResultsList = $('<ul>');
        selectedProject.key_results.forEach((key_res) => {
            keyResultsList.append(`<li>${key_res}</li>`);
        });
        projectKeyResultsCont.append(keyResultsList);

        const projectMembersFieldSetCont = $('.project-members');
        projectMembersFieldSetCont.html('');
        selectedProject.members.forEach((member) => {
            projectMembersFieldSetCont.append(`<a href="/experts/${member.id}"><img class="member-img" src="${member.profile_photo}" />${member.last_name} ${member.first_name}</a>`);
        });

        //edit button
        $('#editButton').remove();
        const editButtonHtml = `<a href="/expert/project/${selectedProject.slug}/edit/" id="editButton" class="btn btn-primary btn-sm">Редактировать</a>`;
        $('.button-proj-edit').append(editButtonHtml);

        //delete button
        $('#deleteButton').remove();
        const deleteButtonHtml = `<a href="/expert/project/${selectedProject.slug}/delete/" id="deleteButton" class="btn btn-danger btn-sm">Удалить</a>`;
        $('.button-proj-delete').append(deleteButtonHtml);

        $('#id_project').show();
    }

    function loadProjectsByCategory(category_id, category_name) {
        $('#dropdownMenuLink').text(`Категория (${category_name || 'Все'})`);
        getUsersProjects('', category_id);
        $('#id_project').hide();
    }

    function createProjectItem(project, index) {

        let categoryNames = project.category.map(cat => cat.name).join(', ');

        return `<div class="card border-dark mb-3" style="width:19%; cursor: pointer;" onclick="loadProject(${index})">
                    <div class="card-body text-dark card-css">
                        <h6 class="card-title" style="font-weight: bold">${project.name}</h6>
                        <h6 class="card-title" >${project.year} г.</h6>
                        <h6 class="card-title" >${categoryNames}</h6>
                        <div class="project-icon-main-cont">
                            <div class="project-icon-cont"><i class="bi bi-eye" style="font-size: 20px" onclick="alert('in progress')"></i> 46</div>
                            <div class="project-icon-cont"><i class="bi bi-hand-thumbs-up" style="font-size: 20px" onclick="alert('in progress')"></i> 46</div>
                        </div>
                    </div>
                </div>`;
    }

    function getUsersProjects(searchQuery = '', category = undefined) {
        const data = {
            "author": {{ user.id }},
            "name": searchQuery
        };

        if (category) {
            data.category = category;
        }

        if (page_number != 0) {
                data.start_record = page_number * recornd_on_page;
        }



        $.ajax({
            url: `/expert/projects/json`,
            type: 'GET',
            data: data,
            success: function (response) {
                userProjects = response.results;
                const projectListCont = $('#id_project_catalog');
                if (page_number == 0)
                    projectListCont.html('');

                if (userProjects.length > 0) {
                    userProjects.forEach((project, index) => {
                        projectListCont.append(createProjectItem(project, index));
                    });
                    loadProject(0);
                    $('#user-project-no-cat').hide();
                } else {
                    $('#user-project-no-cat').html(`No projects found for ${selectedCategory}`).show();
                }

                const user_projects_container_no_projects = $('#user-projects-container-no-projects');
                const user_projects_container = $('#user-projects-container');

                if (userProjects.length > 0) {
                    user_projects_container.show();
                    user_projects_container_no_projects.hide();
                } else {
                    $('#id_project').hide();
                    user_projects_container_no_projects.show();
                }
            }
        });
    }

    $(document).ready(function () {
        $('#dropdownMenuLink').text("Категория (Все)");

        $('#project-search-bar').on('input', function () {
            const searchQuery = $(this).val();
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            searchTimeout = setTimeout(function () {
                getUsersProjects(searchQuery);
            }, 2000);
        });

        getUsersProjects();
    });
</script>








